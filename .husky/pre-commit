#!/bin/sh
set +e  # Don't exit on error - we handle errors manually
echo "ğŸ” Running pre-commit checks..."

# Get staged JavaScript files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(js|mjs|cjs)$' || true)

if [ -z "$STAGED_FILES" ]; then
  echo "ğŸŸ¡ No JavaScript files staged for commit."
  exit 0
fi

echo "ğŸ“ Files to check:"
echo "$STAGED_FILES"
echo ""

# Run ESLint on staged files
echo "ğŸ” Running ESLint..."
echo "$STAGED_FILES" | xargs npx eslint --max-warnings 0 --no-warn-ignored
ESLINT_EXIT_CODE=$?

# Check if ESLint passed
if [ $ESLINT_EXIT_CODE -ne 0 ]; then
  echo ""
  echo "âš ï¸ ESLint found issues. Attempting to auto-fix..."
  echo "ğŸ’¡ Running 'npm run lint:fix'..."

  npm run lint:fix

  echo "ğŸ“¦ Re-staging fixed files..."
  git add -u

  # Run ESLint again to check if all issues are fixed
  echo "ğŸ” Re-checking ESLint..."
  echo "$STAGED_FILES" | xargs npx eslint --max-warnings 0 --no-warn-ignored
  ESLINT_RECHECK_CODE=$?

  if [ $ESLINT_RECHECK_CODE -ne 0 ]; then
    echo ""
    echo "âŒ ESLint still has issues that cannot be auto-fixed. Please fix them manually."
    exit 1
  fi

  echo ""
  echo "âœ… ESLint issues auto-fixed and files re-staged!"
  exit 0
fi

echo ""
echo "âœ… ESLint passed on all staged files!"
exit 0